local dap = require("dap")
local uv = vim.loop

-- Adapter launches st-util automatically
dap.adapters.stlink = {
  type = "executable",
  command = "st-util",
  args = {},  -- st-util default listens on 4242
}

-- Launch configuration
dap.configurations.c = {
  {
    name = "Debug STM32",
    type = "stlink",
    request = "launch",
    program = ".pio/build/nucleo_h753zi/firmware.elf",
    cwd = vim.fn.getcwd(),
    stopAtEntry = true,
    -- Automatically start st-util if it is not running
    preLaunchTask = function()
      -- Try connecting to port 4242 first
      local sock = uv.new_tcp()
      sock:connect("127.0.0.1", 4242, function(err)
        if err then
          print("st-util not running, launching in background...")
          _G.start_stutil_if_needed()
        end
        sock:close()
      end)
    end,
  },
}

dap.configurations.cpp = dap.configurations.c
dap.configurations.asm = dap.configurations.c
